<div class="space-y-6">
  <div class="text-sm text-gray-600">
    <%= link_to goals_path, class: "underline inline-flex items-center gap-1.5" do %>
      <%= icon "arrow-left", size: "w-4 h-4", "aria-hidden": "true" %> <span>一覧に戻る</span>
    <% end %>
  </div>

  <h1 class="text-2xl font-bold"><%= @goal.title %></h1>
  <div class="text-xs text-gray-600">
    <%= @goal.user.nickname.presence || @goal.user.email %> •
    <%= l @goal.created_at, format: :long %> •
    <%= @goal.visibility %>
  </div>

  <div class="flex items-center gap-3">
    <%= render "favorites/button", goal: @goal %>
    <%= x_share_link_to(@goal, text: "目標にチャレンジ中", hashtags: %w[StreakMate 目標]) %>
  </div>

  <p class="whitespace-pre-wrap text-sm"><%= @goal.description %></p>

  <div>
    <h3 class="font-semibold">達成基準</h3>
    <p class="whitespace-pre-wrap text-sm"><%= @goal.success_criteria %></p>
  </div>

  <p class="text-sm text-gray-700">カテゴリ：<%= @goal.category.name %></p>

  <% if @goal.user_id == current_user.id %>
    <div class="space-x-1 text-sm">
      <%= link_to edit_goal_path(@goal), class: "inline-flex items-center gap-1.5 px-2 py-1 rounded hover:bg-gray-50 text-blue-600" do %>
        <%= icon "pencil-square", size: "w-4 h-4", "aria-hidden": "true" %> <span>編集</span>
      <% end %>
      <%= link_to goal_path(@goal),
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                  class: "inline-flex items-center gap-1.5 px-2 py-1 rounded hover:bg-red-50 text-red-600" do %>
        <%= icon "trash", size: "w-4 h-4", "aria-hidden": "true" %> <span>削除</span>
      <% end %>
    </div>
  <% end %>

  <!-- === ゴール配下タスク === -->
  <div class="mt-8">
    <h3 class="font-semibold mb-2">タスク</h3>

    <% if @goal.user_id == current_user.id %>
      <%= form_with url: goal_goal_tasks_path(@goal), method: :post, class: "flex gap-2 mb-4" do %>
        <%= text_field_tag "goal_task[title]", "", placeholder: "タスク名を追加", class: "input flex-1" %>
        <%= button_tag type: "submit", class: "btn-primary inline-flex items-center justify-center gap-1.5 min-h-[44px]" do %>
          <%= icon "plus", variant: :solid, size: "w-5 h-5", "aria-hidden": "true" %> <span>追加</span>
        <% end %>
      <% end %>
    <% end %>

    <ul class="space-y-2">
      <% @goal.goal_tasks.each do |task| %>
        <li class="flex items-center justify-between card">
          <div class="flex items-center gap-2">
            <% if @goal.user_id == current_user.id %>
              <%= button_to goal_goal_task_path(@goal, task, toggle: 1),
                            method: :patch,
                            form: { class: "inline" },
                            class: "inline-flex items-center justify-center h-7 w-7 rounded border hover:bg-gray-50",
                            title: (task.completed? ? '再オープン' : '完了') do %>
                <% if task.completed? %>
                  <%= icon "check-circle", variant: :solid, size: "w-5 h-5", classes: "text-green-600", "aria-hidden": "true" %>
                  <span class="sr-only">完了を取り消す</span>
                <% else %>
                  <%= icon "circle", size: "w-5 h-5", "aria-hidden": "true" %>
                  <span class="sr-only">完了にする</span>
                <% end %>
              <% end %>
            <% end %>
            <span class="<%= 'line-through text-gray-400' if task.completed? %>"><%= task.title %></span>
          </div>
          <% if @goal.user_id == current_user.id %>
            <%= button_to goal_goal_task_path(@goal, task),
                          method: :delete,
                          class: "inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs text-red-600 hover:bg-red-50" do %>
              <%= icon "trash", size: "w-4 h-4", "aria-hidden": "true" %> <span>削除</span>
            <% end %>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
</div>
